name: Dynamic Country EPG (WG++)

on:
  repository_dispatch:
    types: [run_webgrab]
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

jobs:
  grab-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Fetch SiteIni Pack (SilentButeo2)
        uses: actions/checkout@v4
        with:
          repository: SilentButeo2/webgrabplus-siteinipack
          path: siteini-temp

      - name: Move siteini.pack contents to correct location (avoid double nesting)
        run: |
          mkdir -p config/siteini.pack
          mv siteini-temp/siteini.pack/* config/siteini.pack/ 2>/dev/null || true
          rm -rf siteini-temp
          echo "Siteini pack structure:"
          ls -R config/siteini.pack | head -n 40 || true

      - name: Run Python Filter
        run: |
          COUNTRY=${{ github.event.client_payload.country || inputs.country || 'CA' }}
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show generated WebGrab config (debug)
        run: |
          echo "=== WebGrab++.config.xml contents ==="
          cat config/WebGrab++.config.xml || true
          echo "====================================="

      - name: Install .NET 8 runtime + Download & Run WebGrab+Plus natively
        run: |
          echo "Installing .NET 8 runtime..."
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 8.0 --install-dir ./dotnet
          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"
          dotnet --version || echo ".NET version check failed"

          echo "Downloading WebGrab+Plus binaries..."
          WG_VERSION="5.5.0"
          curl -L -o wg.tar.gz "https://github.com/SilentButeo2/WebGrabPlus/raw/master/Install/WebGrabPlus_V${WG_VERSION}.tar.gz" \
            || curl -L -o wg.tar.gz "https://webgrabplus.com/download/script?file=WebGrabPlus_V${WG_VERSION}.tar.gz" \
            || { echo "Failed to download WebGrab+Plus archive"; exit 1; }

          mkdir -p wg
          tar -xzf wg.tar.gz -C wg || { echo "Failed to extract WebGrab+Plus"; exit 1; }
          cd wg/WebGrabPlus || { echo "WebGrabPlus folder not found after extraction"; exit 1; }

          echo "Copying configuration and siteini pack..."
          cp -r ../../config/* ./ 2>/dev/null || true
          mkdir -p siteini.pack
          cp -r ../../config/siteini.pack/* siteini.pack/ 2>/dev/null || true

          echo "Overriding output filename to local output/ folder..."
          mkdir -p output
          # More robust replacement - targets the filename element
          sed -i '/<filename>/c\  <filename>output/'${{ env.COUNTRY }}'.xml</filename>' WebGrab++.config.xml || true
          # Fallback if sed didn't match exactly
          grep -q "output/${{ env.COUNTRY }}.xml" WebGrab++.config.xml || \
            sed -i "s|/data/.*\.xml|output/${{ env.COUNTRY }}.xml|g" WebGrab++.config.xml

          cat WebGrab++.config.xml | grep filename || echo "No filename line found in config"

          echo "Starting WebGrab+Plus natively..."
          dotnet WebGrab+Plus.dll . || echo "WebGrab+Plus exited with code $?"

          echo "Copying results back..."
          ls -la output/*.xml 2>/dev/null || true
          cp output/*.xml ../../epg_db/ 2>/dev/null || true
          cp WebGrab*.log* ../../config/ 2>/dev/null || true

      - name: Show WebGrab logs (critical for debugging)
        if: always()
        run: |
          echo "=== WebGrab++ log files found ==="
          ls -la config/ | grep -i "log\|txt" || echo "No log files"
          echo "=== Log content ==="
          cat config/WebGrab*.log* 2>/dev/null || echo "No readable logs"
          echo "=================="

      - name: Fix Permissions
        if: always()
        run: sudo chown -R $(whoami) epg_db/ config/ || true

      - name: Verify Output
        run: |
          echo "Checking epg_db folder for ${{ env.COUNTRY }}.xml..."
          ls -lh epg_db/ || true
          if [ -f "epg_db/${{ env.COUNTRY }}.xml" ] && [ -s "epg_db/${{ env.COUNTRY }}.xml" ]; then
            echo "✅ SUCCESS: ${{ env.COUNTRY }}.xml exists and has content"
            du -h epg_db/${{ env.COUNTRY }}.xml
            head -n 20 epg_db/${{ env.COUNTRY }}.xml || true
          else
            echo "❌ FAILED: ${{ env.COUNTRY }}.xml missing or empty"
          fi

      - name: Update status.json & Commit changes
        if: always()
        run: |
          python3 -c "
          import json, datetime, os
          country = '${{ env.COUNTRY }}'
          xml_file = f'epg_db/{country}.xml'
          exists = os.path.exists(xml_file) and os.path.getsize(xml_file) > 1000
          d = {
              'country': country,
              'status': 'ready' if exists else 'failed',
              'last_run': datetime.datetime.now(datetime.UTC).isoformat(),
              'file_found': exists,
              'file_size_bytes': os.path.getsize(xml_file) if exists else 0
          }
          with open('epg_db/status.json', 'w') as f:
              json.dump(d, f, indent=2)
          "
          git config --global user.name "EPG Bot"
          git config --global user.email "bot@github.com"
          git add epg_db/
          git commit -m "EPG update for ${{ env.COUNTRY }} – ${{ env.status || 'unknown' }} [skip ci]" || echo "Nothing to commit"
          git push || echo "Push failed (maybe no changes or protected branch)"
