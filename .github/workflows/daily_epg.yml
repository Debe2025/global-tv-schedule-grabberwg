name: Dynamic Country EPG (WG++)

on:
  repository_dispatch:
    types: [run_webgrab]
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

jobs:
  grab-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Fetch SiteIni Pack if missing
      - name: Fetch SiteIni Pack (if not present)
        if: "!exists('config/siteini.pack')"
        uses: actions/checkout@v4
        with:
          repository: SilentButeo2/webgrabplus-siteinipack
          path: siteini-temp

      - name: Move siteini.pack to config
        if: "exists('siteini-temp/siteini.pack')"
        run: |
          mkdir -p config/siteini.pack
          mv siteini-temp/siteini.pack/* config/siteini.pack/ || true
          rm -rf siteini-temp

      # 3. Generate WG++ config dynamically
      - name: Generate WG++ config
        run: |
          COUNTRY=${{ github.event.client_payload.country || inputs.country || 'CA' }}
          mkdir -p config epg_db
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show generated config
        run: |
          ls -lh config/
          cat config/WebGrab++.config.xml || true

      # 4. Install .NET 9 + Download & Extract WG++
      - name: Install .NET 9 and WG++
        run: |
          # Install .NET 9
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 9.0 --install-dir ./dotnet
          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"
          dotnet --version

          # Download WG++ installer
          wget --user-agent="Mozilla/5.0" -O wg_install.tar.gz \
            https://webgrabplus.com/sites/default/files/download/SW/V5.5.0/WebGrabPlus_5.5_install.tar.gz
          tar -zxvf wg_install.tar.gz

      # 5. Prepare WG++ config & output folder
      - name: Prepare WG++ environment
        run: |
          cd .wg++
          mkdir -p output
          cp ../config/WebGrab++.config.xml ./
          # Copy siteini.pack if present
          if [ -d ../config/siteini.pack ]; then
            mkdir -p siteini.pack
            cp -r ../config/siteini.pack/* siteini.pack/
          fi

          # Force output to local folder
          sed -i '/<filename>/c\  <filename>output/'${{ env.COUNTRY }}'.xml</filename>' WebGrab++.config.xml
          grep filename WebGrab++.config.xml

      # 6. Run WG++
      - name: Run WebGrab+Plus
        run: |
          cd .wg++
          [ -f install.sh ] && chmod +x install.sh && ./install.sh || true
          chmod +x run.net.sh
          ./run.net.sh || echo "WG++ exit code: $?"

      # 7. Copy output back to repo
      - name: Copy WG++ output
        run: |
          cp .wg++/output/*.xml epg_db/ || true
          cp .wg++/WebGrab*.log* config/ || true

      # 8. Verify EPG output
      - name: Verify EPG XML
        run: |
          ls -lh epg_db/
          if [ -f "epg_db/${{ env.COUNTRY }}.xml" ] && [ -s "epg_db/${{ env.COUNTRY }}.xml" ]; then
            echo "SUCCESS: ${{ env.COUNTRY }}.xml ready ($(du -h epg_db/${{ env.COUNTRY }}.xml | cut -f1))"
          else
            echo "FAILED: No ${{ env.COUNTRY }}.xml"
            exit 1
          fi

      # 9. Commit and push EPG
      - name: Commit EPG update
        if: always()
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
          git add epg_db/ config/
          git commit -m "EPG ${{ env.COUNTRY }} update $(date +%Y-%m-%d) [skip ci]" || echo "No changes to commit"
          git push || echo "Push skipped"
