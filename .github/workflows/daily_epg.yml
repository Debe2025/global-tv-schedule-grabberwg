name: Dynamic Country EPG (WG++)

on:
  repository_dispatch:
    types: [run_webgrab]
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

jobs:
  grab-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Fetch SiteIni Pack (SilentButeo2)
        uses: actions/checkout@v4
        with:
          repository: SilentButeo2/webgrabplus-siteinipack
          path: siteini-temp

      - name: Move siteini.pack contents to correct location
        run: |
          mkdir -p config/siteini.pack
          mv siteini-temp/siteini.pack/* config/siteini.pack/ 2>/dev/null || true
          rm -rf siteini-temp
          ls -R config/siteini.pack | head -n 40   # debug

      - name: Run Python Filter
        run: |
          COUNTRY=${{ github.event.client_payload.country || inputs.country || 'CA' }}
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show generated config (debug)
        run: |
          echo "WebGrab++.config.xml contents:"
          cat config/WebGrab++.config.xml || true

      - name: Install .NET 8 runtime + Download & Run WebGrab+Plus natively
        run: |
          # Install .NET 8 runtime (WG++ .NET version needs .NET 8+)
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 8.0 --install-dir ./dotnet --no-cdn
          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"
          dotnet --version

          # Download latest stable WebGrab+Plus .NET binaries
          WG_VERSION="5.5.0"
          curl -L -o wg.tar.gz "https://github.com/SilentButeo2/WebGrabPlus/raw/master/Install/WebGrabPlus_V${WG_VERSION}.tar.gz" \
            || curl -L -o wg.tar.gz "https://webgrabplus.com/sites/default/files/download/5.5.0/WebGrabPlus_V${WG_VERSION}.tar.gz"
          
          mkdir -p wg
          tar -xzf wg.tar.gz -C wg
          cd wg/WebGrabPlus

          # Copy your config + siteini pack into the working directory
          cp -r ../../config/* ./
          mkdir -p siteini.pack
          cp -r ../../config/siteini.pack/* siteini.pack/ || true

          # Create output directory mapping (WG++ will write here instead of /data)
          mkdir -p output
          sed -i "s|/data/|output/|g" WebGrab++.config.xml

          echo "Starting WebGrab+Plus natively..."
          dotnet WebGrab+Plus.dll . || echo "WG++ exit code: $?"

          # Move generated XML to epg_db
          ls -la output/*.xml || true
          cp output/*.xml ../../epg_db/ 2>/dev/null || true
          cp WebGrab*.log* ../../config/ 2>/dev/null || true

      - name: Show WebGrab logs
        if: always()
        run: |
          echo "WebGrab logs:"
          ls -la config/ | grep -i log || true
          cat config/WebGrab*.log* 2>/dev/null || echo "No logs found"

      - name: Fix Permissions
        if: always()
        run: sudo chown -R $(whoami) epg_db/ config/ || true

      - name: Verify Output
        run: |
          echo "Checking epg_db/ for ${{ env.COUNTRY }}.xml"
          ls -lh epg_db/ || true
          if [ -f "epg_db/${{ env.COUNTRY }}.xml" ] && [ -s "epg_db/${{ env.COUNTRY }}.xml" ]; then
            echo "SUCCESS: ${{ env.COUNTRY }}.xml found and non-empty"
            du -h epg_db/${{ env.COUNTRY }}.xml
          else
            echo "FAILED: ${{ env.COUNTRY }}.xml missing or empty"
          fi

      - name: Update status.json & Commit
        if: always()
        run: |
          python3 -c "
          import json, datetime, os
          country = '${{ env.COUNTRY }}'
          xml_file = f'epg_db/{country}.xml'
          exists = os.path.exists(xml_file) and os.path.getsize(xml_file) > 1000
          d = {
              'country': country,
              'status': 'ready' if exists else 'failed',
              'last_run': str(datetime.datetime.now(datetime.UTC)),
              'file_found': exists,
              'file_size_bytes': os.path.getsize(xml_file) if exists else 0
          }
          with open('epg_db/status.json', 'w') as f:
              json.dump(d, f, indent=2)
          "
          git config --global user.name "EPG Bot"
          git config --global user.email "bot@github.com"
          git add epg_db/
          git commit -m "EPG update for ${{ env.COUNTRY }} â€“ ${{ env.status || 'unknown' }} [skip ci]" || echo "No changes to commit"
          git push || echo "Push skipped"
