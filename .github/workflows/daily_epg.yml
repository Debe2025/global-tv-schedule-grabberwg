name: Dynamic Country EPG (WG++)

on:
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

jobs:
  grab-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Ensure siteini.pack exists
      - name: Ensure siteini.pack
        run: |
          if [ ! -d "config/siteini.pack" ]; then
            echo "siteini.pack not found, fetching..."
            git clone --depth=1 https://github.com/SilentButeo2/webgrabplus-siteinipack.git siteini-temp
            mkdir -p config/siteini.pack
            mv siteini-temp/siteini.pack/* config/siteini.pack/
            rm -rf siteini-temp
          else
            echo "siteini.pack already exists"
          fi

      # 3. Generate WG++ config
      - name: Generate WG++ config
        run: |
          COUNTRY=${{ github.event.inputs.country }}
          mkdir -p config epg_db
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show config
        run: ls -lh config/ && cat config/WebGrab++.config.xml

      # 4. Install .NET 6 + Download WG++
      - name: Install .NET 6 and WG++
        run: |
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 6.0 --install-dir ./dotnet
          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"
          dotnet --version

          wget -O wg_install.tar.gz \
            https://webgrabplus.com/sites/default/files/download/SW/V5.5.0/WebGrabPlus_5.5_install.tar.gz
          tar -zxvf wg_install.tar.gz

          # Auto-detect extracted folder
          EXTRACTED=$(tar -tf wg_install.tar.gz | head -1 | cut -d/ -f1)

          # Only rename if needed
          if [ "$EXTRACTED" != ".wg++" ]; then
            mv "$EXTRACTED" .wg++
          fi

      # 5. Prepare WG++ environment
      - name: Prepare WG++ environment
        run: |
          cd .wg++
          mkdir -p output
          cp ../config/WebGrab++.config.xml ./

          if [ -d ../config/siteini.pack ]; then
            mkdir -p siteini.pack
            cp -r ../config/siteini.pack/* siteini.pack/
          fi

          # Update output filename
          sed -i '/<filename>/c\  <filename>output/'${{ env.COUNTRY }}'.xml</filename>' WebGrab++.config.xml

      # 6. Run WG++ (patched for GitHub Actions)
      - name: Run WebGrab+Plus
        run: |
          cd .wg++

          # Force IPv4 so WG++ connectivity test works
          echo "precedence ::ffff:0:0/96  100" | sudo tee -a /etc/gai.conf

          # Skip WG++ internal internet test (known bug on GitHub runners)
          export WG_NO_NET_TEST=1

          [ -f install.sh ] && chmod +x install.sh && ./install.sh || true
          chmod +x run.net.sh
          ./run.net.sh || echo "WG++ exit code: $?"

      # 7. Copy output back
      - name: Copy WG++ output
        run: |
          cp .wg++/output/*.xml epg_db/ || true
          cp .wg++/WebGrab*.log* config/ || true

      # 8. Verify and commit
      - name: Commit EPG
        run: |
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
          ls -lh epg_db/
          git add epg_db/ config/
          git commit -m "EPG ${{ env.COUNTRY }} update $(date +%Y-%m-%d) [skip ci]" || echo "No changes"
          git push || echo "Push skipped"
