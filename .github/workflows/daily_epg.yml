name: Dynamic Country EPG (WG++)

on:
  repository_dispatch:
    types: [run_webgrab]
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

jobs:
  grab-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ── Ensure system networking works for WG++ ──
      - name: Prepare networking (WG++ fix)
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates
          sudo update-ca-certificates
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

      # ── Download siteini.pack only if missing ──
      - name: Fetch SiteIni Pack (only if not already in repo)
        if: ${{ !hashFiles('config/siteini.pack/**') }}
        uses: actions/checkout@v4
        with:
          repository: SilentButeo2/webgrabplus-siteinipack
          path: siteini-temp

      - name: Move and commit siteini.pack (once)
        if: ${{ hashFiles('siteini-temp/siteini.pack/**') }}
        run: |
          mkdir -p config/siteini.pack
          mv siteini-temp/siteini.pack/* config/siteini.pack/ || true
          rm -rf siteini-temp
          git config --global user.name "EPG Bot"
          git config --global user.email "bot@github.com"
          git add config/siteini.pack/
          git commit -m "Added/updated siteini.pack (fetched once) [skip ci]" || echo "No changes"
          git push || true

      - name: Run Python Filter (generates config)
        run: |
          COUNTRY=${{ github.event.client_payload.country || inputs.country || 'CA' }}
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show generated config
        run: cat config/WebGrab++.config.xml || true

      - name: Install .NET 9 + Download & Run WebGrab+Plus (v5.5)
        run: |
          # ---- .NET runtime ----
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 9.0 --install-dir ./dotnet

          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$DOTNET_ROOT:$DOTNET_ROOT/tools:$PATH"

          # ---- Critical WG++ networking flags ----
          export DOTNET_SYSTEM_NET_DISABLEIPV6=1
          export DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER=0
          export DOTNET_SYSTEM_NET_HTTP_SOCKETSHTTPHANDLER_HTTP2SUPPORT=false

          dotnet --version

          # ---- Download WG++ ----
          wget --user-agent="Mozilla/5.0" \
            -O wg_install.tar.gz \
            https://webgrabplus.com/sites/default/files/download/SW/V5.5.0/WebGrabPlus_5.5_install.tar.gz

          tar -zxvf wg_install.tar.gz
          cd .wg++

          # ---- Inject config ----
          cp -r ../../config/* ./
          mkdir -p siteini.pack
          cp -r ../../config/siteini.pack/* siteini.pack/ || true

          # ---- Force output file ----
          mkdir -p output
          sed -i '/<filename>/c\  <filename>output/'${COUNTRY}'.xml</filename>' WebGrab++.config.xml
          grep filename WebGrab++.config.xml

          # ---- Run WG++ ----
          chmod +x run.net.sh
          ./run.net.sh

          # ---- Collect output ----
          cp output/*.xml ../../epg_db/ || true
          cp WebGrab*.log* ../../config/ || true

      - name: Show logs
        if: always()
        run: |
          cat .wg++/WebGrab*.log* 2>/dev/null || \
          cat config/WebGrab*.log* 2>/dev/null || \
          echo "No logs found"

      - name: Verify EPG output
        run: |
          ls -lh epg_db/
          if [ -s "epg_db/${COUNTRY}.xml" ]; then
            echo "SUCCESS: ${COUNTRY}.xml generated"
          else
            echo "FAILED: No ${COUNTRY}.xml"
            exit 1
          fi

      - name: Update status & commit
        if: always()
        run: |
          python3 - << 'EOF'
          import json, datetime, os
          c = os.environ['COUNTRY']
          f = f'epg_db/{c}.xml'
          ok = os.path.exists(f) and os.path.getsize(f) > 1000
          data = {
            "country": c,
            "status": "ready" if ok else "failed",
            "last_run": datetime.datetime.now(datetime.UTC).isoformat(),
            "file_found": ok,
            "size": os.path.getsize(f) if ok else 0
          }
          json.dump(data, open("epg_db/status.json","w"), indent=2)
          EOF

          git add epg_db/
          git commit -m "EPG ${COUNTRY} update $(date +%Y-%m-%d) [skip ci]" || echo "No changes"
          git push || true
