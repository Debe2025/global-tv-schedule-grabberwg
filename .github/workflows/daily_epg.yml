name: Dynamic Country EPG (WG++)

on:
  repository_dispatch:
    types: [run_webgrab]
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

jobs:
  grab-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout this repo (includes siteini.pack)
        uses: actions/checkout@v4

      - name: Run Python Filter
        run: |
          COUNTRY=${{ github.event.client_payload.country || inputs.country || 'CA' }}
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show generated WebGrab config (debug)
        run: |
          echo "=== WebGrab++.config.xml contents ==="
          cat config/WebGrab++.config.xml || true
          echo "====================================="

      - name: Install .NET 9 runtime + Download & Run WebGrab+Plus natively
        run: |
          echo "Installing .NET 9 runtime (required for WG++ v5.5+)..."
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 9.0 --install-dir ./dotnet
          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"
          dotnet --version || echo ".NET version check failed"

          echo "Downloading WebGrab+Plus Linux installer..."
          wget --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36" \
            -O WebGrabPlus_5.5_install.tar.gz \
            "https://webgrabplus.com/sites/default/files/download/SW/V5.5.0/WebGrabPlus_5.5_install.tar.gz" \
            || { echo "Download failed"; exit 1; }

          echo "Downloaded file details:"
          ls -lh WebGrabPlus_5.5_install.tar.gz
          file WebGrabPlus_5.5_install.tar.gz

          echo "Extracting archive..."
          tar -zxvf WebGrabPlus_5.5_install.tar.gz || { echo "Extraction failed"; exit 1; }

          echo "Extracted contents:"
          ls -la .

          # Go to .wg++ (official extraction target)
          if [ -d ".wg++" ]; then
            cd .wg++
          else
            echo "No .wg++ folder found after extraction"
            exit 1
          fi

          echo "Current dir: $(pwd)"
          ls -la

          # Copy your config + siteini.pack (now from repo)
          cp -r ../config/* ./ 2>/dev/null || true
          # siteini.pack should already be in correct relative path

          echo "Overriding output path..."
          mkdir -p output
          sed -i '/<filename>/c\  <filename>output/'${{ env.COUNTRY }}'.xml</filename>' WebGrab++.config.xml || true
          grep filename WebGrab++.config.xml || echo "Filename override check"

          echo "Running install.sh if present..."
          [ -f "install.sh" ] && chmod +x install.sh && ./install.sh || echo "No install.sh or skipped"

          echo "Starting WebGrab+Plus..."
          if [ -f "run.net.sh" ]; then
            chmod +x run.net.sh
            ./run.net.sh || echo "run.net.sh exited $?"
          else
            dotnet bin.net/WebGrab+Plus.dll . || echo "Direct run exited $?"
          fi

          echo "Copying generated EPG back..."
          cp output/*.xml ../../epg_db/ 2>/dev/null || true
          cp WebGrab*.log* ../../config/ 2>/dev/null || true

      - name: Show WebGrab logs
        if: always()
        run: |
          echo "WebGrab logs:"
          ls -la config/ | grep -i log || true
          cat config/WebGrab*.log* 2>/dev/null || echo "No logs"

      - name: Fix Permissions
        if: always()
        run: sudo chown -R $(whoami) epg_db/ config/ || true

      - name: Verify Output
        run: |
          echo "Checking epg_db/${{ env.COUNTRY }}.xml ..."
          ls -lh epg_db/ || true
          if [ -f "epg_db/${{ env.COUNTRY }}.xml" ] && [ -s "epg_db/${{ env.COUNTRY }}.xml" ]; then
            echo "SUCCESS - file exists and has size > 0"
            du -h epg_db/${{ env.COUNTRY }}.xml
          else
            echo "FAILED - no or empty XML"
          fi

      - name: Update status.json & Commit
        if: always()
        run: |
          python3 -c "
          import json, datetime, os
          c = '${{ env.COUNTRY }}'
          f = f'epg_db/{c}.xml'
          ex = os.path.exists(f) and os.path.getsize(f) > 1000
          d = {'country': c, 'status': 'ready' if ex else 'failed', 'last_run': datetime.datetime.now(datetime.UTC).isoformat(), 'file_found': ex, 'size': os.path.getsize(f) if ex else 0}
          with open('epg_db/status.json', 'w') as fp: json.dump(d, fp, indent=2)
          "
          git config --global user.name "EPG Bot"
          git config --global user.email "bot@github.com"
          git add epg_db/
          git commit -m "EPG update for ${{ env.COUNTRY }} [skip ci]" || echo "No changes"
          git push || echo "Push skipped"
