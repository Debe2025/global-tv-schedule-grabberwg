name: Dynamic Country EPG (WG++)

on:
  repository_dispatch:
    types: [run_webgrab]
  workflow_dispatch:
    inputs:
      country:
        description: 'Country Code (e.g., CA)'
        required: true
        default: 'CA'

permissions:
  contents: write

jobs:
  grab-epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------------------------
      # Run Python filter to generate config
      # ---------------------------
      - name: Generate WG++ config
        run: |
          COUNTRY=${{ github.event.client_payload.country || inputs.country || 'CA' }}
          python3 filter_wg_channels.py "$COUNTRY"
          echo "COUNTRY=$COUNTRY" >> $GITHUB_ENV

      - name: Show generated config
        run: cat config/WebGrab++.config.xml || true

      # ---------------------------
      # Install .NET 9 runtime
      # ---------------------------
      - name: Install .NET 9
        run: |
          wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --channel 9.0 --install-dir ./dotnet
          export DOTNET_ROOT=$(pwd)/dotnet
          export PATH="$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools"
          dotnet --version

      # ---------------------------
      # Install CA certificates (fixes WG++ "No internet")
      # ---------------------------
      - name: Install CA certs
        run: sudo apt-get update && sudo apt-get install -y ca-certificates

      # ---------------------------
      # Download and extract WG++ installer
      # ---------------------------
      - name: Download & Extract WebGrabPlus
        run: |
          wget --user-agent="Mozilla/5.0" \
            -O wg_install.tar.gz \
            https://webgrabplus.com/sites/default/files/download/SW/V5.5.0/WebGrabPlus_5.5_install.tar.gz
          tar -zxvf wg_install.tar.gz
          cd .wg++

      # ---------------------------
      # Prepare WG++ config
      # ---------------------------
      - name: Prepare WG++ config & output folder
        run: |
          mkdir -p output
          cp ../config/WebGrab++.config.xml ./
          # Optional: copy siteini.pack if present
          if [ -d ../config/siteini.pack ]; then
            mkdir -p siteini.pack
            cp -r ../config/siteini.pack/* siteini.pack/
          fi

      # ---------------------------
      # Run WG++
      # ---------------------------
      - name: Run WebGrab+Plus
        run: |
          chmod +x run.net.sh
          ./run.net.sh

      # ---------------------------
      # Verify output
      # ---------------------------
      - name: Verify EPG output
        run: |
          ls -lh output/
          if [ -f "output/${{ env.COUNTRY }}.xml" ] && [ -s "output/${{ env.COUNTRY }}.xml" ]; then
            echo "SUCCESS: ${{ env.COUNTRY }}.xml generated"
          else
            echo "FAILED: No ${{ env.COUNTRY }}.xml"
            exit 1
          fi

      # ---------------------------
      # Commit output safely
      # ---------------------------
      - name: Commit generated XML
        run: |
          # Configure git identity dynamically
          if ! git config user.name >/dev/null; then
            git config --local user.name "${GITHUB_ACTOR}"
          fi
          if ! git config user.email >/dev/null; then
            git config --local user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          fi

          # Copy WG++ output to repo
          mkdir -p epg_db
          cp output/*.xml epg_db/

          git add epg_db/

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "EPG ${{ env.COUNTRY }} update $(date +%Y-%m-%d) [skip ci]"
          git push
